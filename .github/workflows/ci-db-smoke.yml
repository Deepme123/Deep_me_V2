name: CI DB Smoke

on:
  pull_request:
  workflow_dispatch:

jobs:
  db-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: deepme
          POSTGRES_PASSWORD: deepme_pw
          POSTGRES_DB: deepme_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U deepme -d deepme_db"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 20

    env:
      ENV: test
      APP_ENV: local
      DATABASE_DRIVER: psycopg2
      DATABASE_URL: postgresql+psycopg2://deepme:deepme_pw@127.0.0.1:5432/deepme_db
      OPENAI_API_KEY: dummy-key

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Wait for database
        run: |
          python - <<'PY'
          import os
          import time
          from sqlalchemy import create_engine, text

          db_url = os.environ["DATABASE_URL"]
          last_error = None
          for _ in range(30):
              try:
                  engine = create_engine(db_url, pool_pre_ping=True)
                  with engine.connect() as conn:
                      conn.execute(text("SELECT 1"))
                  print("database is ready")
                  break
              except Exception as exc:  # pragma: no cover
                  last_error = exc
                  time.sleep(2)
          else:
              raise RuntimeError(f"database did not become ready: {last_error}")
          PY

      - name: Import app.main
        run: python -c "import app.main"

      - name: Alembic upgrade head
        run: alembic upgrade head

      - name: Smoke test /health/db
        run: |
          python - <<'PY'
          from fastapi.testclient import TestClient
          from app.main import app

          with TestClient(app) as client:
              response = client.get("/health/db")

          print(response.status_code, response.text)
          assert response.status_code == 200, response.text
          assert response.json().get("ok") is True
          PY
